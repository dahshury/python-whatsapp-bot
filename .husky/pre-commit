#!/bin/sh
set -e

# Helpers to run steps and show output on failure
run_step() {
	step_name="$1"
	shift
	echo "[pre-commit] $step_name..."
	"$@" || {
		echo "[pre-commit] $step_name failed ($?)." >&2
		exit 1
	}
}

# Check if there are staged frontend files
if git diff --cached --name-only --diff-filter=ACMR | grep -q '^app/frontend/'; then
	run_step "Running Biome (fix) on staged files" pnpm --filter ./app/frontend biome check --fix --unsafe --staged
	run_step "Running Biome (strict) on staged files" pnpm --filter ./app/frontend biome check --staged
fi

run_step "Running TypeScript typecheck" pnpm --filter ./app/frontend exec tsc --noEmit --pretty

# Temporarily disabled: run_step "Running Knip (unused files/exports check)" pnpm dlx knip --no-config-hints --exports

# Format staged markdown files
if git diff --cached --name-only --diff-filter=ACMR | grep -q '\.md$'; then
	run_step "Linting/formatting staged Markdown" sh -c "git diff --cached --name-only --diff-filter=ACMR | grep '\.md$' | xargs -I {} uv run --with mdformat --with mdformat-gfm --with mdformat-frontmatter --with mdformat-ruff mdformat {}"
	run_step "Re-staging formatted Markdown files" sh -c "git diff --cached --name-only --diff-filter=ACMR | grep '\.md$' | xargs git add"
fi

run_step "Running Ruff (Python lint with fixes)" uv run ruff check --fix --unsafe-fixes

echo "[pre-commit] All checks passed."
