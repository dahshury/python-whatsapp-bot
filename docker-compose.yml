# Local docker-compose configuration

services:
  postgres:
    image: python-whatsapp-bot-postgres:latest
    build:
      context: .
      dockerfile: docker/postgres/Dockerfile
    container_name: reservation_postgres
    environment:
      - POSTGRES_DB=whatsapp_bot
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d whatsapp_bot"]
      interval: 10s
      timeout: 5s
      retries: 5
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: reservation_backend
    env_file:
      - .env
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      prometheus: { condition: service_started }
    environment:
      - ENV=${ENVIRONMENT:-development}
      - DATABASE_URL=postgresql+psycopg://postgres:postgres@postgres:5432/whatsapp_bot
    volumes:
      - ${MOUNT_BACKEND:-./app:/app/app}
      - ./run.py:/app/run.py
      - ./.env:/app/.env
      - ./scripts:/app/scripts
    restart: on-failure
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    command: >
      sh -c "until pg_isready -h postgres -p 5432 -d whatsapp_bot; do echo 'waiting for postgres...'; sleep 1; done; uvicorn run:app --host 0.0.0.0 --port 8000"
  frontend:
    build:
      context: ./app/frontend
      dockerfile: Dockerfile
    container_name: reservation_frontend
    env_file:
      - .env
    ports:
      - "3000:3000"
    depends_on:
      - backend
    environment:
      - ENV=${ENVIRONMENT:-development}
    restart: on-failure
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
    ports:
      - "9090:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=24h"
    restart: on-failure

  alertmanager:
    image: prom/alertmanager:v0.28.0
    container_name: alertmanager
    volumes:
      - type: bind
        source: ./prometheus/alertmanager.yml
        target: /etc/alertmanager/alertmanager.yml
        read_only: true
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
    ports:
      - "9093:9093"
    restart: on-failure

  # Alertmanager Discord adapter: formats alerts into rich embeds
  discord-adapter:
    image: benjojo/alertmanager-discord:latest
    container_name: alertmanager_discord
    env_file:
      - .env
    environment:
      - LISTEN_ADDRESS=0.0.0.0:9094
    ports:
      - "9094:9094"
    restart: on-failure
